# üìû Rejei√ß√£o Autom√°tica de Chamadas

## üéØ Vis√£o Geral

Sistema autom√°tico que **rejeita chamadas do WhatsApp** e envia uma mensagem ao cliente pedindo para enviar texto ao inv√©s de ligar.

**Perfeito para:** Cl√≠nicas, consult√≥rios e empresas que preferem atendimento via mensagem.

---

## üí° Como Funciona

```
1. Cliente liga via WhatsApp
   ‚Üì
2. Webhook recebe evento "call"
   ‚Üì
3. Sistema verifica configura√ß√£o:
   rejeitarChamadasAutomaticamente = true?
   ‚Üì
4. Sistema rejeita chamada (POST /call/reject)
   ‚Üì
5. Sistema envia mensagem autom√°tica:
   "üì± Estou ocupado no momento.
   Por favor, envie uma mensagem e
   retornarei assim que poss√≠vel!"
   ‚Üì
‚úÖ Cliente recebe mensagem ao inv√©s de chamada
```

---

## üì± Experi√™ncia do Cliente

### Antes (sem rejei√ß√£o)
```
Cliente liga ‚Üí Toca...toca...toca... ‚Üí Sem resposta
Cliente desiste üòû
```

### Agora (com rejei√ß√£o autom√°tica)
```
Cliente liga ‚Üí Chamada rejeitada automaticamente
‚Üì
Cliente recebe mensagem:
"üì± Ol√°!
No momento n√£o estou dispon√≠vel para chamadas.
Por favor, envie uma mensagem de texto e
retornarei assim que poss√≠vel!
Obrigado pela compreens√£o. üòä"
‚Üì
Cliente envia mensagem de texto ‚úÖ
```

---

## ‚öôÔ∏è Configura√ß√£o

### 1. Campos no Firestore (negocios/{id})

```typescript
{
  // Ativar/desativar rejei√ß√£o
  rejeitarChamadasAutomaticamente: boolean,
  
  // Mensagem customiz√°vel
  mensagemRejeicaoChamada: string
}
```

### 2. Mensagem Padr√£o

Se `mensagemRejeicaoChamada` n√£o estiver definido, usa:

```
üì± *Ol√°!*

No momento n√£o estou dispon√≠vel para chamadas.

Por favor, envie uma *mensagem de texto* e 
retornarei assim que poss√≠vel!

Obrigado pela compreens√£o. üòä
```

### 3. Mensagens Customizadas (Exemplos)

**Cl√≠nica M√©dica:**
```
üè• *Cl√≠nica Sa√∫de+*

Para melhor atend√™-lo, preferimos que 
voc√™ envie uma *mensagem de texto* 
com sua d√∫vida ou solicita√ß√£o.

Nossa equipe responder√° em breve!
```

**Sal√£o de Beleza:**
```
üíá *Studio Beauty*

Oi! Estou atendendo no momento.

Envie uma *mensagem* para:
‚Ä¢ Agendar hor√°rio
‚Ä¢ Tirar d√∫vidas
‚Ä¢ Or√ßamentos

Te respondo rapidinho! üòä
```

**Consult√≥rio Odontol√≥gico:**
```
ü¶∑ *Odonto Center*

Para agilizar seu atendimento:

üì± Envie uma mensagem com:
‚Ä¢ Nome completo
‚Ä¢ Motivo do contato

Retornaremos em instantes!
```

---

## üîß Implementa√ß√£o T√©cnica

### Webhook Processa Evento "call"

üìÅ `src/app/api/webhooks/uazapi/route.ts`

```typescript
// Evento recebido quando algu√©m liga
{
  "event": "call",
  "data": {
    "from": "5581995207521@s.whatsapp.net",
    "id": "ABEiGmo8oqkAcAKrBYQAAAAA_1",
    "status": "offer",  // Chamada recebida
    "isVideo": false,
    "isGroup": false
  }
}

// Fluxo:
1. Busca neg√≥cios com rejeitarChamadasAutomaticamente = true
2. Rejeita chamada: POST /call/reject
3. Envia mensagem autom√°tica: POST /send/text
4. Registra em chamadas_rejeitadas (log)
```

---

## üìä Dados Salvos (Log)

### Collection: `negocios/{id}/chamadas_rejeitadas`

```typescript
{
  numero: "81995207521",
  callId: "ABEiGmo8oqkAcAKrBYQAAAAA_1",
  isVideo: false,
  isGroup: false,
  rejeitadaEm: Timestamp,
  mensagemEnviada: true
}
```

**√ötil para:**
- Ver quantas chamadas foram rejeitadas
- Identificar clientes que tentam ligar
- Analisar se a estrat√©gia est√° funcionando

---

## üé® Interface (Sugest√£o)

### Configura√ß√µes ‚Üí Notifica√ß√µes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Rejei√ß√£o Autom√°tica de Chamadas    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ [ ] Rejeitar chamadas               ‚îÇ
‚îÇ     automaticamente                 ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚ÑπÔ∏è Quando ativado, chamadas ser√£o  ‚îÇ
‚îÇ    rejeitadas e uma mensagem ser√°   ‚îÇ
‚îÇ    enviada ao cliente.              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Mensagem de Resposta            ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ üì± Ol√°!                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ No momento n√£o estou            ‚îÇ ‚îÇ
‚îÇ ‚îÇ dispon√≠vel para chamadas.       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Por favor, envie uma            ‚îÇ ‚îÇ
‚îÇ ‚îÇ mensagem de texto...            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Caracteres: 156 / 1000              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [üíæ Salvar Configura√ß√µes]           ‚îÇ
‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìà Estat√≠sticas (Dashboard)

### M√©tricas √öteis

```typescript
// Total de chamadas rejeitadas (√∫ltimos 30 dias)
const chamadasRef = adminDb
  .collection(`negocios/${businessId}/chamadas_rejeitadas`)
  .where('rejeitadaEm', '>=', startOf30DaysAgo)
  .get();

console.log(`Chamadas rejeitadas: ${chamadasRef.size}`);

// Hor√°rios com mais chamadas
const porHora = chamadasRef.docs.reduce((acc, doc) => {
  const hora = doc.data().rejeitadaEm.toDate().getHours();
  acc[hora] = (acc[hora] || 0) + 1;
  return acc;
}, {});

console.log('Hor√°rios com mais chamadas:', porHora);
// Exemplo: { 9: 15, 10: 23, 14: 18, 15: 12 }
```

---

## üîî Configura√ß√£o do Webhook

**Adicionar evento `call` √† configura√ß√£o:**

```json
{
  "url": "https://seu-dominio.com/api/webhooks/uazapi",
  "events": [
    "connection",
    "messages",
    "messages_update",
    "sender",
    "call"  ‚Üê NOVO
  ],
  "excludeMessages": ["wasSentByApi"]
}
```

---

## üß™ Testes

### Teste Manual

1. **Ativar no Firestore:**
```typescript
await updateDoc(doc(db, 'negocios', businessId), {
  rejeitarChamadasAutomaticamente: true,
  mensagemRejeicaoChamada: "Teste: envie mensagem por favor"
});
```

2. **Ligar para o WhatsApp:**
- Abra o WhatsApp
- Ligue para o n√∫mero do neg√≥cio
- Chamada deve ser rejeitada automaticamente
- Voc√™ deve receber a mensagem configurada

3. **Verificar Logs:**
```bash
[WEBHOOK-CALL] Chamada recebida de 5581995207521@s.whatsapp.net
[WEBHOOK-CALL] Chamada de 81995207521 rejeitada
[WEBHOOK-CALL] Mensagem autom√°tica enviada para 81995207521
```

4. **Verificar Firestore:**
```typescript
// Collection: negocios/{id}/chamadas_rejeitadas
{
  numero: "81995207521",
  rejeitadaEm: Timestamp(...),
  mensagemEnviada: true
}
```

---

## ‚ö†Ô∏è Limita√ß√µes e Considera√ß√µes

### 1. Tipos de Chamada
- ‚úÖ Chamadas de voz: Funciona
- ‚úÖ Chamadas de v√≠deo: Funciona
- ‚ùå Chamadas em grupo: Rejeita mas pode n√£o enviar mensagem individual

### 2. Timing
- Rejei√ß√£o √© **quase instant√¢nea** (< 1 segundo)
- Mensagem √© enviada **1 segundo ap√≥s** rejei√ß√£o

### 3. WhatsApp Conectado
- S√≥ funciona se `whatsappConectado === true`
- Se desconectar, chamadas n√£o ser√£o rejeitadas

---

## üí° Casos de Uso

### Cl√≠nicas e Consult√≥rios
**Por qu√™:** M√©dicos/dentistas ocupados n√£o podem atender chamadas durante consultas.

**Benef√≠cio:** Cliente envia mensagem ‚Üí Equipe responde quando dispon√≠vel.

### Sal√µes e Barbearias
**Por qu√™:** Profissionais de m√£os ocupadas durante atendimento.

**Benef√≠cio:** Mensagens podem ser respondidas entre clientes.

### Lojas e Estabelecimentos
**Por qu√™:** Melhor organiza√ß√£o de atendimento.

**Benef√≠cio:** Mensagens ficam registradas e podem ser respondidas com calma.

### Servi√ßos de Agendamento
**Por qu√™:** Priorizar agendamentos via mensagem/sistema.

**Benef√≠cio:** Cliente usa link de agendamento ao inv√©s de ligar.

---

## üéØ Benef√≠cios

### Para o Gestor
- ‚úÖ **Menos interrup√ß√µes** durante atendimentos
- ‚úÖ **Melhor organiza√ß√£o** de solicita√ß√µes
- ‚úÖ **Hist√≥rico escrito** de todas as conversas
- ‚úÖ **Tempo de resposta** controlado

### Para o Cliente
- ‚úÖ **Resposta imediata** (mesmo que autom√°tica)
- ‚úÖ **Sabe que mensagem ser√° lida**
- ‚úÖ **N√£o fica no vazio**
- ‚úÖ **Pode explicar melhor** por escrito

---

## üìã Checklist de Implementa√ß√£o

### Backend
- [x] Processar evento `call` no webhook
- [x] Fun√ß√£o `rejectCall()` implementada
- [x] Fun√ß√£o `sendAutoReplyMessage()` implementada
- [x] Salvar log em `chamadas_rejeitadas`
- [x] Campos no `ConfiguracoesNegocio`

### Webhook
- [ ] Adicionar evento `call` na configura√ß√£o global
- [ ] Testar recebimento de evento
- [ ] Validar rejei√ß√£o de chamada

### Frontend (Sugest√£o)
- [ ] Adicionar toggle em Configura√ß√µes ‚Üí Notifica√ß√µes
- [ ] Campo de texto para mensagem customizada
- [ ] Preview da mensagem
- [ ] Dashboard com estat√≠sticas de chamadas

### Testes
- [ ] Testar chamada de voz
- [ ] Testar chamada de v√≠deo
- [ ] Testar mensagem customizada
- [ ] Verificar log no Firestore

---

## üöÄ Exemplo de Implementa√ß√£o no Frontend

```typescript
// Componente: Configura√ß√µes ‚Üí Notifica√ß√µes

const [rejeitarChamadas, setRejeitarChamadas] = useState(false);
const [mensagem, setMensagem] = useState(
  "üì± *Ol√°!*\n\nNo momento n√£o estou dispon√≠vel..."
);

const handleSave = async () => {
  await updateDoc(doc(db, 'negocios', businessId), {
    rejeitarChamadasAutomaticamente: rejeitarChamadas,
    mensagemRejeicaoChamada: mensagem
  });
  
  toast.success('Configura√ß√µes salvas!');
};

return (
  <Card>
    <CardHeader>
      <CardTitle>Rejei√ß√£o Autom√°tica de Chamadas</CardTitle>
      <CardDescription>
        Rejeite chamadas automaticamente e envie uma mensagem
      </CardDescription>
    </CardHeader>
    <CardContent>
      <div className="flex items-center space-x-2">
        <Switch
          checked={rejeitarChamadas}
          onCheckedChange={setRejeitarChamadas}
        />
        <Label>Rejeitar chamadas automaticamente</Label>
      </div>
      
      {rejeitarChamadas && (
        <div className="mt-4">
          <Label>Mensagem de Resposta</Label>
          <Textarea
            value={mensagem}
            onChange={(e) => setMensagem(e.target.value)}
            rows={6}
            maxLength={1000}
          />
          <p className="text-sm text-muted-foreground mt-1">
            {mensagem.length} / 1000 caracteres
          </p>
        </div>
      )}
      
      <Button onClick={handleSave} className="mt-4">
        üíæ Salvar Configura√ß√µes
      </Button>
    </CardContent>
  </Card>
);
```

---

## ‚úÖ Conclus√£o

O sistema de **Rejei√ß√£o Autom√°tica de Chamadas** oferece:

- üìû **Menos interrup√ß√µes** no dia a dia
- üí¨ **Mais organiza√ß√£o** no atendimento
- üìä **M√©tricas** de tentativas de contato
- üòä **Melhor experi√™ncia** para o cliente

**Status:** ‚úÖ Implementado e pronto para uso

**Pr√≥ximo passo:** Adicionar evento `call` ao webhook e testar!
