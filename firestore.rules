rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 🔐 RBAC - Sistema Enterprise de Permissões
    function hasRole(role) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.roles.hasAny([role]) &&
             get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.active == true;
    }
    
    function hasPermission(permission) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.permissions.hasAny([permission, '*'])) &&
             get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.active == true;
    }
    
    function isAdmin() {
      return hasRole('super_admin') || hasRole('admin');
    }
    
    // 👑 SUPER ADMIN/ADMIN TEM ACESSO TOTAL
    match /{document=**} {
      allow read, write: if isAdmin();
    }
    
    // 🔐 User Roles - Gerenciamento de permissões
    match /user_roles/{userId} {
      allow read: if request.auth.uid == userId || hasPermission('manage_users');
      allow write: if hasPermission('manage_users');
    }
    
    // ✅ Negócios - Leitura pública (página de agendamento) / Escrita para dono ou admin
    match /negocios/{businessId} {
      // Permitir leitura pública dos dados básicos do negócio
      allow read: if true;
      
      // Permitir escrita para o dono OU admin
      allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      
      // 📅 Agendamentos - Leitura pública (ver horários) / Escrita dono ou admin
      match /agendamentos/{appointmentId} {
        allow read: if true; // Público para ver disponibilidade
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 👥 Clientes - Apenas dono ou admin (dados sensíveis)
      match /clientes/{clientId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 💇 Serviços - Leitura pública (página de agendamento) / Escrita dono ou admin
      match /servicos/{serviceId} {
        allow read: if true; // Público para ver serviços disponíveis
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 👔 Profissionais - Leitura pública (página de agendamento) / Escrita dono ou admin
      match /profissionais/{professionalId} {
        allow read: if true; // Público para ver profissionais
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 🚫 Datas Bloqueadas - Leitura pública (verificar disponibilidade) / Escrita dono ou admin
      match /datasBloqueadas/{blockId} {
        allow read: if true; // Público para verificar datas bloqueadas
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 📢 Campanhas - Apenas dono ou admin
      match /campanhas/{campaignId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
    }
    
    // ✅ Admin - Dados administrativos
    match /admin/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Apenas via Firebase Admin SDK
    }
    
    // ✅ Planos - Leitura pública (página de planos) / Escrita apenas admin
    match /planos/{planId} {
      allow read: if true;
      allow write: if isAdmin(); // Admin pode editar via interface
    }
  }
}