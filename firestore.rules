rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ” SISTEMA DE ADMIN SEGURO - USA LISTA ESTÃTICA DE EMAILS
    // Lista de emails administradores (mesma de src/lib/admin-list.ts)
    function isAdmin() {
      // Lista de emails dos administradores
      let adminEmails = [
        'italocesar.hd@gmail.com',
        'eduardosoarestonon@gmail.com'
      ];
      
      return request.auth != null && 
             request.auth.token.email != null &&
             request.auth.token.email in adminEmails;
    }
    
    // âœ… System Admins - Lista de administradores do sistema
    match /system_admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin(); // Admin pode gerenciar outros admins
    }
    
    // âœ… NegÃ³cios - Leitura pÃºblica (pÃ¡gina de agendamento) / Escrita para dono ou admin
    match /negocios/{businessId} {
      // Permitir leitura pÃºblica dos dados bÃ¡sicos do negÃ³cio
      allow read: if true;
      
      // Permitir escrita para o dono OU admin
      allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      
      // ğŸ“… Agendamentos - Leitura pÃºblica (ver horÃ¡rios) / Escrita dono ou admin
      match /agendamentos/{appointmentId} {
        allow read: if true; // PÃºblico para ver disponibilidade
        // âœ… CORRIGIDO: Permitir que dono do negÃ³cio escreva em SEUS agendamentos
        allow create, update: if request.auth != null && (request.auth.uid == businessId || isAdmin());
        allow delete: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // ğŸ‘¥ Clientes - Apenas dono ou admin (dados sensÃ­veis)
      match /clientes/{clientId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // ğŸ’‡ ServiÃ§os - Leitura pÃºblica (pÃ¡gina de agendamento) / Escrita dono ou admin
      match /servicos/{serviceId} {
        allow read: if true; // PÃºblico para ver serviÃ§os disponÃ­veis
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // ğŸ‘” Profissionais - Leitura pÃºblica (pÃ¡gina de agendamento) / Escrita dono ou admin
      match /profissionais/{professionalId} {
        allow read: if true; // PÃºblico para ver profissionais
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // ğŸš« Datas Bloqueadas - Leitura pÃºblica (verificar disponibilidade) / Escrita dono ou admin
      match /datasBloqueadas/{blockId} {
        allow read: if true; // PÃºblico para verificar datas bloqueadas
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // ğŸ“¢ Campanhas - Apenas dono ou admin
      match /campanhas/{campaignId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
    }
    
    // âœ… Admin - Dados administrativos
    match /admin/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Apenas via Firebase Admin SDK
    }
    
    // âœ… Planos - Leitura pÃºblica (pÃ¡gina de planos) / Escrita apenas admin
    match /planos/{planId} {
      allow read: if true;
      allow write: if isAdmin(); // Admin pode editar via interface
    }
    
    // âœ… ConfiguraÃ§Ãµes do Sistema - Apenas admin
    match /configuracoes_sistema/{docId} {
      allow read, write: if isAdmin();
    }
    
    // ğŸ”’ Outras collections - Bloqueadas por padrÃ£o
    // Admin sempre tem acesso atravÃ©s das regras especÃ­ficas acima
  }
}