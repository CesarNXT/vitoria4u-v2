rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 🔐 SISTEMA DE ADMIN SEGURO - USA CUSTOM CLAIMS
    // Custom claims são definidos no Firebase Auth pelo backend
    // e são verificados automaticamente pelo token JWT
    function isAdmin() {
      // Verifica se o token JWT tem custom claim 'admin' = true
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    function isSuperAdmin() {
      // Para futuro: se precisar distinguir super_admin de admin
      return request.auth != null && 
             request.auth.token.super_admin == true;
    }
    
    // ✅ System Admins - Lista de administradores do sistema
    match /system_admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin(); // Admin pode gerenciar outros admins
    }
    
    // ✅ Negócios - Leitura pública (página de agendamento) / Escrita para dono ou admin
    match /negocios/{businessId} {
      // Permitir leitura pública dos dados básicos do negócio
      allow read: if true;
      
      // Permitir escrita para o dono OU admin
      allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      
      // 📅 Agendamentos - Leitura pública (ver horários) / Escrita dono ou admin
      match /agendamentos/{appointmentId} {
        allow read: if true; // Público para ver disponibilidade
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 👥 Clientes - Apenas dono ou admin (dados sensíveis)
      match /clientes/{clientId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 💇 Serviços - Leitura pública (página de agendamento) / Escrita dono ou admin
      match /servicos/{serviceId} {
        allow read: if true; // Público para ver serviços disponíveis
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 👔 Profissionais - Leitura pública (página de agendamento) / Escrita dono ou admin
      match /profissionais/{professionalId} {
        allow read: if true; // Público para ver profissionais
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 🚫 Datas Bloqueadas - Leitura pública (verificar disponibilidade) / Escrita dono ou admin
      match /datasBloqueadas/{blockId} {
        allow read: if true; // Público para verificar datas bloqueadas
        allow write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
      
      // 📢 Campanhas - Apenas dono ou admin
      match /campanhas/{campaignId} {
        allow read, write: if request.auth != null && (request.auth.uid == businessId || isAdmin());
      }
    }
    
    // ✅ Admin - Dados administrativos
    match /admin/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Apenas via Firebase Admin SDK
    }
    
    // ✅ Planos - Leitura pública (página de planos) / Escrita apenas admin
    match /planos/{planId} {
      allow read: if true;
      allow write: if isAdmin(); // Admin pode editar via interface
    }
    
    // ✅ Configurações do Sistema - Apenas admin
    match /configuracoes_sistema/{docId} {
      allow read, write: if isAdmin();
    }
    
    // 🔒 Outras collections - Bloqueadas por padrão
    // Admin sempre tem acesso através das regras específicas acima
  }
}